#!/bin/sh

exit

# Macros
BRO=w3m
SRC=/mnt/disk/livres/autres/site_md
DST=/var/www/htdocs/site_gmi

# Make news
function make_news {
	slug=$1
	lang=$(get_lang $slug)
	title=$(get_title $SRC'/'$lang'/news/index.md')
	echo '## '$title
	i=1
	for file in $SRC'/'$lang'/news/'*; do
		if [[ $(basename $file) != 'index.md' &&
			 $i < 10 ]]; then
			title=$(get_title $file)	
			date=$(get_date $file)
			slug=$(echo $file | sed -E "s|$SRC||" | sed -E 's/\.md/\.html/')
			echo '*'$date'* - ['$title']('$slug')\n'
			i=$(( i + 1 ))
		fi
	done
	echo '\n[>>](/'$lang'/news/index.html)'
	echo '***'
}

# Get language
function get_lang {
	lang=$(echo "$1" | grep -Eo '^\/[a-z]{2}' | grep -Eo '[a-z]{2}')
	echo $lang
}

# Process individual post
function make_post {
	file_in=$1
	file_in=$(echo $file_in | sed -E 's|//|/|g')

	if [ -d $file_in ]; then
		file_out=$(echo $file_in | sed -E "s|$SRC|$DST|")
		mkdir -p $file_out
		main $file_in
	elif [ $(echo $file_in | cut -d '.' -f2) == "md" ]; then

		echo '-->'$file_in

		# Prepare output file name
		file_out=$(echo $file_in | sed -E "s|$SRC|$DST|" | sed -E 's/\.md/\.html/')

		# Get post slug
		file_slug=$(echo $file_out | sed -E "s|$DST||")

		# Get language
		lang=$(get_lang $file_slug)

		# Append header to $file_out 
		cat $TMPL'/header-'$lang > $file_out

		# Edit canonical link
		sed -i "s|\/xx.html|$file_slug|" $file_out

		# Append navigation
		make_nav $(dirname $file_in | sed -E "s|$DST||") >> $file_out

		# Append markdown content to $file_out
		# (might need to leave a blank line at the top)
		if [[ $file_slug == '/'$lang'/index.html' &&
			 -f $SRC'/'$lang'/news/index.md' ]]; then
			make_news $file_slug | lowdown --html-no-head-ids --html-no-skiphtml --html-no-escapehtml >> $file_out
		fi
		lowdown --html-no-head-ids --html-no-skiphtml --html-no-escapehtml $file_in >> $file_out

		# Append index list to index.html
		if [ $(basename $file_in) == "index.md" ]; then
			make_index $file_in >> $file_out
		fi

		# Append footer to $file_out
		cat $TMPL'/footer-'$lang >> $file_out
	fi
}

# Loop through all posts
function main {
	cp $SRC/index.html $DST/
	for file in $1/*; do
		# Skip 
		if [[ $(basename $file) == "templates" ||
				-n $(echo $(basename $file) | grep -oE '\.hide') ||
				$(basename $file) == "index.html" ||
				$(basename $file) == "images" ||
				$(basename $file) == "archive" ]]; then
			continue
		fi
		make_post $file
	done
}

case $1 in
	run)
		main $SRC;;
	*)
		make_post `pwd`'/'$1;;
esac
